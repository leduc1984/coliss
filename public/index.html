<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon ORAX - Professional MMO Experience</title>
    
    <!-- Professional UI Design System -->
    <link rel="stylesheet" href="styles/pokemon-orax-ui.css">
    <link rel="stylesheet" href="styles/pokemon-orax-chat.css">
    <link rel="stylesheet" href="styles/pokemon-orax-chat-xml.css">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="css/debug.css">
    <link rel="stylesheet" href="css/battle.css">
    
    <!-- Babylon.js and Dependencies -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- CANNON.js Physics Engine with Multiple CDN Fallbacks -->
    <script>
        (function() {
            const cannonUrls = [
                'https://cdn.jsdelivr.net/npm/cannon@0.6.2/build/cannon.min.js', // Working version
                'https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js', // Alternate version
                'https://unpkg.com/cannon@0.6.2/build/cannon.min.js' // Alternate version
            ];
            
            let cannonLoaded = false;
            let currentUrlIndex = 0;
            
            function loadCannonJS() {
                if (currentUrlIndex >= cannonUrls.length) {
                    console.warn('⚠️ CANNON.js failed to load from all CDNs, physics disabled');
                    // Show user notification
                    showPhysicsDisabledNotification();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = cannonUrls[currentUrlIndex];
                
                script.onload = function() {
                    cannonLoaded = true;
                    console.log('✅ CANNON.js loaded successfully from:', cannonUrls[currentUrlIndex]);
                    // Hide any previous notifications
                    hidePhysicsNotification();
                };
                
                script.onerror = function() {
                    console.warn('❌ Failed to load CANNON.js from:', cannonUrls[currentUrlIndex]);
                    currentUrlIndex++;
                    loadCannonJS();
                };
                
                document.head.appendChild(script);
            }
            
            function showPhysicsDisabledNotification() {
                // Create notification element
                const notification = document.createElement('div');
                notification.id = 'physics-disabled-notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(255, 165, 0, 0.9);
                    color: white;
                    padding: 16px;
                    border-radius: 8px;
                    z-index: 9999;
                    max-width: 300px;
                    font-family: 'Inter', sans-serif;
                    border: 1px solid rgba(255, 255, 255, 0.2);
                `;
                notification.innerHTML = `
                    <h4 style="margin: 0 0 8px 0; font-size: 14px;">⚠️ Physics Disabled</h4>
                    <p style="margin: 0; font-size: 12px; line-height: 1.4;">
                        CANNON.js physics engine failed to load. The game will use basic collision detection instead.
                    </p>
                `;
                document.body.appendChild(notification);
                
                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 10000);
            }
            
            function hidePhysicsNotification() {
                const notification = document.getElementById('physics-disabled-notification');
                if (notification && notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }
            
            loadCannonJS();
        })();
    </script>
    
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    
    <!-- Professional Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Login/Register Screen -->
    <div id="auth-screen" class="screen active">
        <div class="auth-container">
            <div class="game-logo">
                <h1>Pokemon MMO</h1>
                <h2>Omega Ruby Style</h2>
            </div>
            
            <!-- Login Form -->
            <div id="login-form" class="auth-form active">
                <h3>Welcome Back, Trainer!</h3>
                <form id="loginForm">
                    <div class="input-group">
                        <label for="loginInput">Username or Email</label>
                        <input type="text" id="loginInput" name="login" required>
                    </div>
                    <div class="input-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" name="password" autocomplete="current-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Start Adventure</button>
                </form>
                <p class="auth-switch">
                    New trainer? <a href="#" id="showRegister">Create Account</a>
                </p>
            </div>
            
            <!-- Register Form -->
            <div id="register-form" class="auth-form">
                <h3>Begin Your Pokemon Journey!</h3>
                <form id="registerForm">
                    <div class="input-group">
                        <label for="regUsername">Trainer Name</label>
                        <input type="text" id="regUsername" name="username" required>
                        <small>3-50 characters, letters, numbers, and underscores only</small>
                    </div>
                    <div class="input-group">
                        <label for="regEmail">Email</label>
                        <input type="email" id="regEmail" name="email" required>
                    </div>
                    <div class="input-group">
                        <label for="regPassword">Password</label>
                        <input type="password" id="regPassword" name="password" autocomplete="new-password" required>
                        <small>8+ chars, 1 uppercase, 1 lowercase, 1 number, 1 special character</small>
                    </div>
                    <div class="input-group">
                        <label for="regConfirmPassword">Confirm Password</label>
                        <input type="password" id="regConfirmPassword" name="confirmPassword" autocomplete="new-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Trainer</button>
                </form>
                <p class="auth-switch">
                    Already a trainer? <a href="#" id="showLogin">Sign In</a>
                </p>
            </div>
            
            <div id="auth-message" class="message"></div>
        </div>
    </div>
    
    <!-- Game Screen with Professional ORAX Layout -->
    <div id="game-screen" class="screen">
        <div class="pokemon-orax-container">
            <!-- Professional Top Navigation -->
            <nav class="pokemon-orax-navbar">
                <a href="#" class="pokemon-orax-navbar__brand">
                    Pokemon ORAX
                </a>
                
                <div class="pokemon-orax-navbar__center">
                    <div class="pokemon-card" style="padding: var(--space-2) var(--space-4); margin: 0;">
                        <span id="currentMap" style="font-weight: 600; color: var(--primary);">Loading...</span>
                    </div>
                </div>
                
                <div class="pokemon-orax-navbar__actions">
                    <div class="pokemon-orax-navbar__user">
                        <div class="pokemon-orax-navbar__avatar" id="playerAvatar">T</div>
                        <div>
                            <div id="playerName" style="font-weight: 600; font-size: var(--text-sm);">Trainer Name</div>
                            <div id="playerRole" class="pokemon-orax-navbar__role pokemon-orax-navbar__role--user">user</div>
                        </div>
                    </div>


                    <div id="adminControls" style="display: none; padding: 0 var(--space-2);">
                        <!-- Admin-specific controls will be populated here by the game logic -->
                    </div>
                    
                    
                    <button id="logoutBtn" class="pokemon-btn pokemon-btn--secondary pokemon-btn--sm">
                        ↗️ Logout
                    </button>
                </div>
            </nav>
            
            <!-- Main Content Area -->
            <div class="pokemon-orax-content">
                <!-- 3D Game Area (Full Screen) -->
                <div class="pokemon-orax-game-area" style="position: relative; width: 100%; height: 100vh;">
                    <canvas id="gameCanvas"></canvas>
                    
                    <!-- Game Overlays -->
                    <div id="controls-info" style="position: absolute; bottom: 20px; left: 20px; color: white; background: rgba(0,0,0,0.7); padding: 12px; border-radius: 8px; z-index: 5;">
                        <div class="control-hint">Use WASD or Arrow Keys to move • Hold Shift to run</div>
                        <div class="online-count">Players online: <span id="onlineCount">1</span></div>
                    </div>
                    
                    <!-- Battle Container -->
                    <div id="battle-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;"></div>

                    <!-- Debug Overlay -->
                    <div id="debug-overlay" class="debug-overlay" style="position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.9); color: white; padding: 16px; border-radius: 8px; font-family: monospace; display: none; z-index: 5;">
                        <h4 style="margin: 0 0 12px 0; color: #ffeb3b;">🔍 Debug Info</h4>
                        <div class="debug-info" style="margin-bottom: 8px;">Position: <span id="debug-position">0, 0, 0</span></div>
                        <div class="debug-info" style="margin-bottom: 8px;">Rotation: <span id="debug-rotation">0°</span></div>
                        <div class="debug-info" style="margin-bottom: 8px;">Camera: <span id="debug-camera">α: 0, β: 0, r: 0</span></div>
                        <div class="debug-info" style="margin-bottom: 12px;">Moving: <span id="debug-moving">No</span></div>
                        <div class="debug-controls" style="font-size: 12px; color: #ccc;">
                            Press P for debug info<br>
                            Press F1 to toggle this overlay
                        </div>
                    </div>
                    
                    <!-- Movement Indicator -->
                    <div id="movement-indicator" class="movement-indicator" style="position: absolute; bottom: 20px; right: 400px; z-index: 5;">
                        <div class="movement-cross">
                            <div class="movement-arrow up" id="arrow-up"></div>
                            <div class="movement-arrow down" id="arrow-down"></div>
                            <div class="movement-arrow left" id="arrow-left"></div>
                            <div class="movement-arrow right" id="arrow-right"></div>
                            <div class="movement-center" id="movement-center"></div>
                        </div>
                    </div>
                    
                    <!-- New Chat Window -->
                    <div id="new-chat-container" style="position: absolute; width: 420px; right: 20px; bottom: 20px; z-index: 100;">
                        <div style="position: relative; width: 100%; background: rgba(33, 37, 41, 0.9); backdrop-filter: blur(10px); border: 1px solid var(--gray-700); border-radius: var(--radius-lg); box-shadow: var(--shadow-xl); display: flex; flex-direction: column; height: 400px;">
                            <header data-drag-handle="true" style="flex-shrink: 0; padding: 12px; background: rgba(0,0,0,0.3); cursor: grab; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-weight: bold; font-size: 14px; color: white;">Chat</span>
                                    </div>
                                    <button id="new-toggleChat" style="padding: 4px; border-radius: 50%; background: transparent; color: #ccc; border: none;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                    </button>
                                </div>
                            </header>

                            <div id="new-chat-tabs-container" style="flex-shrink: 0; display: flex; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding: 0 8px; overflow-x: auto;">
                                <!-- Tabs will be generated by JS -->
                            </div>
                            
                            <div style="flex-grow: 1; padding: 16px; overflow-y: auto;">
                                <div id="new-chat-messages" style="display: flex; flex-direction: column; gap: 12px; font-size: 14px;">
                                    <!-- Messages will be dynamically added here -->
                                </div>
                                <div id="new-chat-messages-end"></div>
                            </div>

                            <div style="padding: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <div style="display: flex; align-items: center; background: rgba(0,0,0,0.4); border-radius: 8px;">
                                    <input id="new-chatInput" type="text" placeholder="Message..." style="width: 100%; background: transparent; padding: 8px 12px; color: white; border: none; outline: none;">
                                    <button id="new-sendChat" style="padding: 8px; margin-right: 4px; color: #ccc; background: transparent; border: none; cursor: pointer;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pokedex Window -->
                    <div id="pokedex-window" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100;">
                        <div class="pokemon-card" style="width: 800px; max-height: 70vh; display: flex; flex-direction: column; background: rgba(33, 37, 41, 0.9); backdrop-filter: blur(10px); border: 1px solid var(--gray-700); border-radius: var(--radius-lg); box-shadow: var(--shadow-xl);">
                            <header class="d-flex align-items-center justify-content-between p-4" style="border-bottom: 1px solid var(--gray-700); cursor: grab;" data-drag-handle="true">
                                <h2 style="font-size: var(--text-lg); font-weight: 700; color: var(--white);">Pokédex</h2>
                                <button id="pokedex-close-button" class="pokemon-btn" style="padding: var(--space-2); background: transparent; color: white;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                </button>
                            </header>
                            <div style="padding: var(--space-4); overflow-y: auto;">
                                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: var(--space-4);">
                                    <!-- Pokedex entries will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Bar -->
                    <div style="position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 16px; padding: 8px; background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); border-radius: 9999px; z-index: 20;">
                        <div class="group relative">
                            <button id="pokedex-button" class="pokemon-btn" style="width: 48px; height: 48px; background: rgba(52, 58, 64, 0.6); border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.8);">
                                <!-- Pokedex Icon SVG -->
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="6" y1="12" x2="2" y2="12"></line><line x1="22" y1="12" x2="18" y2="12"></line></svg>
                            </button>
                        </div>
                        <!-- Other buttons can be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- Loading Screen -->
    <div id="loading-screen" class="screen">
        <div class="loading-container">
            <div class="pokeball-loader"></div>
            <h3>Loading Pokemon World...</h3>
            <div id="loading-text">Connecting to server...</div>
            <div id="loading-progress-container" style="width: 300px; height: 20px; background: rgba(255,255,255,0.2); border-radius: 10px; margin: 20px auto; overflow: hidden;">
                <div id="loading-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #ff6b6b, #4ecdc4); border-radius: 10px; transition: width 0.3s ease;"></div>
            </div>
            <div id="loading-progress-text" style="font-size: 14px; margin-top: 10px;">0%</div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="js/auth.js"></script>
    <script src="js/draggable.js"></script>
    <script src="js/new_chat.js"></script>
    <script src="js/battle-sprite-manager.js"></script>
    <script src="js/battle-animation-manager.js"></script>
    <script src="js/battle-interface.js"></script>
    <script src="js/battle-module.js"></script>
    <script src="js/player.js"></script>
    <script src="js/game.js"></script>
    <script src="js/main.js"></script>
    <script src="js/pokedex.js"></script>
    <!-- Run battle test after all other scripts are loaded -->
    <script src="js/battle-test.js"></script>
</body>
</html>