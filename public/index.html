<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon ORAX - Professional MMO Experience</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Professional UI Design System -->
    <link rel="stylesheet" href="styles/pokemon-orax-ui.css">
    <link rel="stylesheet" href="styles/pokemon-orax-chat.css">
    <link rel="stylesheet" href="styles/pokemon-orax-chat-xml.css">
    <link rel="stylesheet" href="styles/chat-modern.css">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="css/debug.css">
    <link rel="stylesheet" href="css/battle.css">
    
    <!-- Babylon.js and Dependencies -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- CANNON.js Physics Engine with Multiple CDN Fallbacks -->
    <script>
        (function() {
            const cannonUrls = [
                'https://cdn.jsdelivr.net/npm/cannon@0.6.2/build/cannon.min.js', // Working version
                'https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js', // Alternate version
                'https://unpkg.com/cannon@0.6.2/build/cannon.min.js' // Alternate version
            ];
            
            let cannonLoaded = false;
            let currentUrlIndex = 0;
            
            function loadCannonJS() {
                if (currentUrlIndex >= cannonUrls.length) {
                    console.warn('⚠️ CANNON.js failed to load from all CDNs, physics disabled');
                    // Show user notification
                    showPhysicsDisabledNotification();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = cannonUrls[currentUrlIndex];
                
                script.onload = function() {
                    cannonLoaded = true;
                    console.log('✅ CANNON.js loaded successfully from:', cannonUrls[currentUrlIndex]);
                    // Hide any previous notifications
                    hidePhysicsNotification();
                };
                
                script.onerror = function() {
                    console.warn('❌ Failed to load CANNON.js from:', cannonUrls[currentUrlIndex]);
                    currentUrlIndex++;
                    loadCannonJS();
                };
                
                document.head.appendChild(script);
            }
            
            function showPhysicsDisabledNotification() {
                // Create notification element
                const notification = document.createElement('div');
                notification.id = 'physics-disabled-notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(255, 165, 0, 0.9);
                    color: white;
                    padding: 16px;
                    border-radius: 8px;
                    z-index: 9999;
                    max-width: 300px;
                    font-family: 'Inter', sans-serif;
                    border: 1px solid rgba(255, 255, 255, 0.2);
                `;
                notification.innerHTML = `
                    <h4 style="margin: 0 0 8px 0; font-size: 14px;">⚠️ Physics Disabled</h4>
                    <p style="margin: 0; font-size: 12px; line-height: 1.4;">
                        CANNON.js physics engine failed to load. The game will use basic collision detection instead.
                    </p>
                `;
                document.body.appendChild(notification);
                
                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 10000);
            }
            
            function hidePhysicsNotification() {
                const notification = document.getElementById('physics-disabled-notification');
                if (notification && notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }
            
            loadCannonJS();
        })();
    </script>
    
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    
    <!-- Professional Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple webkit scrollbar styling for any scrollable element */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>
<body>
    <!-- Login/Register Screen -->
    <div id="auth-screen" class="screen active">
        <div class="auth-container">
            <div class="game-logo">
                <h1>Pokemon MMO</h1>
                <h2>Omega Ruby Style</h2>
            </div>
            
            <!-- Login Form -->
            <div id="login-form" class="auth-form active">
                <h3>Welcome Back, Trainer!</h3>
                <form id="loginForm">
                    <div class="input-group">
                        <label for="loginInput">Username or Email</label>
                        <input type="text" id="loginInput" name="login" required>
                    </div>
                    <div class="input-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" name="password" autocomplete="current-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Start Adventure</button>
                </form>
                <p class="auth-switch">
                    New trainer? <a href="#" id="showRegister">Create Account</a>
                </p>
            </div>
            
            <!-- Register Form -->
            <div id="register-form" class="auth-form">
                <h3>Begin Your Pokemon Journey!</h3>
                <form id="registerForm">
                    <div class="input-group">
                        <label for="regUsername">Trainer Name</label>
                        <input type="text" id="regUsername" name="username" required>
                        <small>3-50 characters, letters, numbers, and underscores only</small>
                    </div>
                    <div class="input-group">
                        <label for="regEmail">Email</label>
                        <input type="email" id="regEmail" name="email" required>
                    </div>
                    <div class="input-group">
                        <label for="regPassword">Password</label>
                        <input type="password" id="regPassword" name="password" autocomplete="new-password" required>
                        <small>8+ chars, 1 uppercase, 1 lowercase, 1 number, 1 special character</small>
                    </div>
                    <div class="input-group">
                        <label for="regConfirmPassword">Confirm Password</label>
                        <input type="password" id="regConfirmPassword" name="confirmPassword" autocomplete="new-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Trainer</button>
                </form>
                <p class="auth-switch">
                    Already a trainer? <a href="#" id="showLogin">Sign In</a>
                </p>
            </div>
            
            <div id="auth-message" class="message"></div>
        </div>
    </div>
    
    <!-- Game Screen with Professional ORAX Layout -->
    <div id="game-screen" class="screen">
        <div class="pokemon-orax-container">
            <!-- Professional Top Navigation -->
            <nav class="pokemon-orax-navbar">
                <a href="#" class="pokemon-orax-navbar__brand">
                    Pokemon ORAX
                </a>
                
                <div class="pokemon-orax-navbar__center">
                    <div class="pokemon-card" style="padding: var(--space-2) var(--space-4); margin: 0;">
                        <span id="currentMap" style="font-weight: 600; color: var(--primary);">Loading...</span>
                    </div>
                </div>
                
                <div class="pokemon-orax-navbar__actions">
                    <div class="pokemon-orax-navbar__user">
                        <div class="pokemon-orax-navbar__avatar" id="playerAvatar">T</div>
                        <div>
                            <div id="playerName" style="font-weight: 600; font-size: var(--text-sm);">Trainer Name</div>
                            <div id="playerRole" class="pokemon-orax-navbar__role pokemon-orax-navbar__role--user">user</div>
                        </div>
                    </div>
                    
                    
                    <button id="logoutBtn" class="pokemon-btn pokemon-btn--secondary pokemon-btn--sm">
                        ↗️ Logout
                    </button>
                </div>
            </nav>
            
            <!-- Main Content Area -->
            <div class="pokemon-orax-content">
                <!-- 3D Game Area (Full Screen) -->
                <div class="pokemon-orax-game-area" style="position: relative; width: 100%; height: 100vh;">
                    <canvas id="gameCanvas"></canvas>
                    
                    <!-- Game Overlays -->
                    <div id="controls-info" style="position: absolute; bottom: 20px; left: 20px; color: white; background: rgba(0,0,0,0.7); padding: 12px; border-radius: 8px; z-index: 5;">
                        <div class="control-hint">Use WASD or Arrow Keys to move • Hold Shift to run</div>
                        <div class="online-count">Players online: <span id="onlineCount">1</span></div>
                    </div>
                    
                    <!-- Battle Container -->
                    <div id="battle-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;"></div>

                    <!-- New Modern Chat Window -->
                    <div id="new-chat-container" class="relative w-[420px] bg-gray-900/60 backdrop-blur-xl border border-white/10 rounded-xl shadow-2xl flex flex-col transition-all duration-300 ease-in-out" 
                         style="position: absolute; height: 400px; overflow: hidden; display: none;">
                        <!-- Chat Header with Drag Handle -->
                        <div data-drag-handle="true" class="flex-shrink-0 p-3 bg-black/30 cursor-grab active:cursor-grabbing border-b border-white/5">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 text-cyan-300">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9 8s9 3.582 9 8z" />
                                    </svg>
                                    <span class="font-bold text-sm">Chat</span>
                                </div>
                                <button id="new-toggleChat" class="p-1 rounded-full hover:bg-white/10 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 text-gray-400">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Chat Tabs -->
                        <div class="flex-shrink-0 flex items-center border-b border-white/10 px-2 overflow-x-auto" style="display: flex;">
                            <button class="relative flex-shrink-0 flex items-center gap-2 text-sm px-3 py-2 border-b-2 transition-colors border-cyan-400 text-white" data-channel="global" data-tab-id="1">
                                <span>🌍</span>
                                <span>Global</span>
                            </button>
                            <button class="relative flex-shrink-0 flex items-center gap-2 text-sm px-3 py-2 border-b-2 transition-colors border-transparent text-gray-400 hover:text-white hover:bg-white/5" data-channel="english" data-tab-id="2">
                                <span>🇬🇧</span>
                                <span>English</span>
                            </button>
                            <button id="new-add-tab-button" class="ml-2 p-1.5 rounded-full text-gray-400 hover:bg-white/10 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Chat Messages -->
                        <div class="flex-grow p-4 overflow-y-auto" style="display: block;">
                            <div class="flex flex-col gap-3 text-sm">
                                <div>
                                    <span class="text-cyan-400 font-bold">System</span>
                                    <span class="text-white/90">: Welcome to Pokemon MMO! Type /help for commands.</span>
                                </div>
                            </div>
                            <div id="new-chat-messages-end"></div>
                        </div>

                        <!-- Chat Input Area -->
                        <div class="p-3 border-t border-white/10" style="display: block;">
                            <div class="flex items-center bg-black/40 rounded-lg ring-1 ring-transparent focus-within:ring-cyan-400/50 transition-all">
                                <input
                                    type="text"
                                    id="new-chatInput"
                                    placeholder="Message in #global..."
                                    class="w-full bg-transparent px-3 py-2 text-white placeholder-gray-400 focus:outline-none"
                                />
                                <button id="new-sendChat" class="p-2 mr-1 text-gray-400 hover:text-cyan-300 transition-colors rounded-md hover:bg-white/10">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Add Tab Modal -->
                        <div id="new-add-tab-modal" class="absolute inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 rounded-xl overflow-hidden" style="display: none;">
                            <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-80 border border-white/10">
                                <h3 class="text-lg font-semibold mb-4 text-white">Create New Channel</h3>
                                <input 
                                    type="text"
                                    id="new-new-tab-name"
                                    placeholder="Channel name"
                                    class="w-full bg-black/40 rounded border border-white/20 px-3 py-1.5 text-sm text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all"
                                />
                                <div class="flex justify-end gap-3 mt-4">
                                    <button id="new-cancel-add-tab" class="px-4 py-2 bg-white/10 rounded-lg text-sm hover:bg-white/20 transition-colors">Cancel</button>
                                    <button id="new-confirm-add-tab" class="px-4 py-2 bg-cyan-600 rounded-lg text-sm hover:bg-cyan-500 font-semibold transition-colors">Create</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Debug Overlay -->
                    <div id="debug-overlay" class="debug-overlay" style="position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.9); color: white; padding: 16px; border-radius: 8px; font-family: monospace; display: none; z-index: 5;">
                        <h4 style="margin: 0 0 12px 0; color: #ffeb3b;">🔍 Debug Info</h4>
                        <div class="debug-info" style="margin-bottom: 8px;">Position: <span id="debug-position">0, 0, 0</span></div>
                        <div class="debug-info" style="margin-bottom: 8px;">Rotation: <span id="debug-rotation">0°</span></div>
                        <div class="debug-info" style="margin-bottom: 8px;">Camera: <span id="debug-camera">α: 0, β: 0, r: 0</span></div>
                        <div class="debug-info" style="margin-bottom: 12px;">Moving: <span id="debug-moving">No</span></div>
                        <div class="debug-controls" style="font-size: 12px; color: #ccc;">
                            Press P for debug info<br>
                            Press F1 to toggle this overlay
                        </div>
                    </div>
                    
                    <!-- Movement Indicator -->
                    <div id="movement-indicator" class="movement-indicator" style="position: absolute; bottom: 20px; right: 400px; z-index: 5;">
                        <div class="movement-cross">
                            <div class="movement-arrow up" id="arrow-up"></div>
                            <div class="movement-arrow down" id="arrow-down"></div>
                            <div class="movement-arrow left" id="arrow-left"></div>
                            <div class="movement-arrow right" id="arrow-right"></div>
                            <div class="movement-center" id="movement-center"></div>
                        </div>
                    </div>
                    
                    <!-- XML-Based Chat Panel -->
                    <div class="chatframe" id="chat-panel">
                        <!-- Chat Header with Tabs -->
                        <div class="chatframe-top" id="chat-header">
                            <div class="chat-tabs" id="chat-tabs">
                                <button class="chat-tab-button togglebutton-normal togglebutton-normal--active" data-channel="global">
                                    <span class="chat-tab-icon">🌍</span>
                                    <span>Global</span>
                                </button>
                                <button class="chat-tab-button togglebutton-normal" data-channel="english">
                                    <span class="chat-tab-icon">🇬🇧</span>
                                    <span>English</span>
                                </button>
                                <button class="chat-tab-button togglebutton-add" id="add-tab-button">
                                    <span class="chat-tab-icon">+</span>
                                </button>
                                <button class="chat-tab-button togglebutton-remove" id="remove-tab-button" style="display: none;">
                                    <span class="chat-tab-icon">-</span>
                                </button>
                                <button class="chat-tab-button togglebutton-settings" id="settings-button">
                                    <span class="chat-tab-icon">⚙️</span>
                                </button>
                            </div>
                            <button class="hideButton" id="toggleChat">−</button>
                        </div>
                        
                        <!-- Chat Content Container -->
                        <div class="chatframe-content" id="chat-content">
                            <!-- Chat Messages Scroll Pane -->
                            <div class="chat-scrollpane" id="chat-messages">
                                <!-- Messages will be dynamically added here -->
                            </div>
                            
                            <!-- Chat Input Area -->
                            <div class="chatframe-bottom">
                                <div class="chat-input-container">
                                    <div class="chat-input-wrapper">
                                        <textarea class="editfield" id="chatInput" 
                                                 placeholder="Type message or /help for commands..."
                                                 rows="1"></textarea>
                                    </div>
                                    <button class="chat-send-button button" id="sendChat">➤</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- Loading Screen -->
    <div id="loading-screen" class="screen">
        <div class="loading-container">
            <div class="pokeball-loader"></div>
            <h3>Loading Pokemon World...</h3>
            <div id="loading-text">Connecting to server...</div>
            <div id="loading-progress-container" style="width: 300px; height: 20px; background: rgba(255,255,255,0.2); border-radius: 10px; margin: 20px auto; overflow: hidden;">
                <div id="loading-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #ff6b6b, #4ecdc4); border-radius: 10px; transition: width 0.3s ease;"></div>
            </div>
            <div id="loading-progress-text" style="font-size: 14px; margin-top: 10px;">0%</div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="js/auth.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/draggable.js"></script>
    <script src="js/main-ui.js"></script>
    <script src="js/battle-sprite-manager.js"></script>
    <script src="js/battle-animation-manager.js"></script>
    <script src="js/battle-interface.js"></script>
    <script src="js/battle-module.js"></script>
    <script src="js/player.js"></script>
    <script src="js/player-controller-test.js"></script>
    <script src="js/game.js"></script>
    <script src="js/main.js"></script>
    <!-- Run battle test after all other scripts are loaded -->
    <script src="js/battle-test.js"></script>
    <!-- Test UI components (remove in production) -->
    <script src="js/test-ui-components.js"></script>
</body>
</html>